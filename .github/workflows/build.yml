# =====================================================================
# ðŸ—ï¸ BUILD PIPELINE WORKFLOW
# =====================================================================
name: ðŸ—ï¸ Build Pipeline

# ---------------------------------------------------------------------
# ðŸ“‹ WORKFLOW TRIGGERS
# ---------------------------------------------------------------------
on:
  push: # ðŸ“¤ When we push changes
    branches: # ðŸŒ¿ Only for these branches
      - master
      - develop
      - bugfix/*
      - hotfix/*
      - release/*
    paths-ignore: # ðŸš« Ignoring markdown file changes
      - "**/*.md"
  pull_request: # ðŸ”„ Also on pull request events
  workflow_dispatch: # ðŸ‘† Manual trigger from Actions tab

# ---------------------------------------------------------------------
# ðŸŒ ENVIRONMENT VARIABLES
# ---------------------------------------------------------------------
env:
  FOUNDRY_PROFILE: ci

# ---------------------------------------------------------------------
# ðŸ’¼ JOBS
# ---------------------------------------------------------------------
jobs:
  # âœ… INITIAL CHECK JOB
  # -------------------------------------------------------------
  check:
    name: âœ… State Verifier
    runs-on: ubuntu-latest
    outputs:
      skip_ci: ${{ steps.check_initial_commit.outputs.skip_ci }}
    steps:
      - name: ðŸ“¥ Checking out repository code
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0 # Fetches all history for all branches and tags

      - name: ðŸ” Check Initial Commit
        id: check_initial_commit
        run: |
          # Use a git command to count the number of revisions
          # If the count is 1, then this is the initial commit
          if [ "$(git rev-list --count HEAD)" -eq 1 ]; then
            echo "This is the initial commit."
            # Set the environment variable "skip_ci" to true, signifying CI should not run for the initial commit
            echo "skip_ci=true" >> $GITHUB_OUTPUT
          else
            # If the count is not 1, this is not the initial commit
            # Set the environment variable "skip_ci" to false, signifying CI should run
            echo "skip_ci=false" >> $GITHUB_OUTPUT
          fi

  # ðŸ—ï¸ BUILD AND TEST JOB
  # -------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build & Test
    if: needs.check.outputs.skip_ci != 'true'
    runs-on: ubuntu-latest
    needs: [check]
    timeout-minutes: 20

    steps:
      - name: ðŸ” Force HTTPS for GitHub
        run: git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: ðŸ“¥ Checking out repository code
        uses: actions/checkout@v6.0.1

      # ðŸ› ï¸ SETUP ENVIRONMENT
      - name: ðŸ”§ Install Foundry
        uses: foundry-rs/foundry-toolchain@v1.6.0
        with:
          version: nightly

      - name: âœ… Ensure Forge on PATH
        shell: bash
        run: |
          echo "$HOME/.foundry/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.foundry/bin:$PATH"
          forge --version

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4.2.0
        with:
          run_install: false

      - name: ðŸŸ¢ Install Node.js
        uses: actions/setup-node@v6
        with:
          cache: "pnpm"
          node-version-file: 'package.json'

      # ðŸ“š DEPENDENCIES
      - name: ðŸ“š Install dependencies
        run: pnpm install

      # ðŸ—ï¸ BUILD
      - name: ðŸ—ï¸ Build the apps and packages
        run: pnpm run build

      # ðŸ§ª TEST
      - name: ðŸ§ª Execute tests
        run: pnpm run test

  # ðŸ“¦ RELEASE JOB
  # -------------------------------------------------------------
  release:
    name: ðŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ github.ref_name == 'master' }}
    permissions:
      contents: write
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0 # Fetches all history for all branches and tags

      - name: ðŸ“ Generate changelog
        uses: orhun/git-cliff-action@v4.7.0
        id: git-cliff
        with:
          config: cliff.toml # Configuration file for git-cliff
          args: -vv --latest --strip all # Verbose output, latest changes, strip unnecessary details
        env:
          OUTPUT: CHANGES.md # Output file for the changelog

      - name: ðŸ·ï¸ Set release info
        id: release
        shell: bash
        run: |
          version=$(jq -r '.version' package.json)
          echo "version=${version}" >> $GITHUB_OUTPUT

          # Read contents of changelog into variable 'changelog_content'
          changelog=$(cat ${{ steps.git-cliff.outputs.changelog }})
          # Remove first two lines from 'changelog'
          changelog="$(printf "$changelog" | tail -n +3)"
          # Save the value of 'changelog' back into the GitHub environment output
          {
              echo "notes<<EOF"
              echo "$changelog"
              echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: ðŸš€ Create the release
        uses: nekofar/create-github-release@v1.0.15
        with:
          tag: v${{ steps.release.outputs.version }}
          title: v${{ steps.release.outputs.version }}
          notes: ${{ steps.release.outputs.notes }}
          draft: true # Release will be created as a draft
          prerelease: ${{ contains(steps.release.outputs.version, '-rc') || contains(steps.release.outputs.version, '-beta') || contains(steps.release.outputs.version, '-alpha') }}

# ---------------------------------------------------------------------
# ðŸ”„ CONCURRENCY CONTROL
# ---------------------------------------------------------------------
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true # Cancels previous runs for same group-key
